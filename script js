document.addEventListener("DOMContentLoaded", function () {
    // Handle "Book" and "Review" Buttons
    document.querySelectorAll(".booking").forEach(button => {
        button.addEventListener("click", function () {
            window.location.href = "#tourForm"; // Scrolls to booking form
        });
    });

    document.querySelectorAll(".user-review").forEach(button => {
        button.addEventListener("click", function () {
            window.location.href = "#review-form"; // Scrolls to review form
        });
    });

    //defining book tour globally for it to be called
    function bookTour() {
        window.location.href = "#tourForm"; // Scrolls to the booking form
    }
    
    // So that it's globally accessible
    window.bookTour = bookTour;

    // Search bar at the nav bar functionality
    function searchDestination() {
        let searchInput = document.querySelector(".search-bar").value.trim().toLowerCase();
        fetch("http://localhost:3000/destinations") // Fetch from JSON Server
        .then(response => response.json())
        .then(destinations => {
            // Convert all destination names to lowercase for comparison
            let destinationNames = destinations.map(dest => dest.name.toLowerCase());

            if (destinationNames.includes(searchInput)) {
                alert(`We have tours to ${searchInput.charAt(0).toUpperCase() + searchInput.slice(1)}! Click 'Book' to reserve your spot.`);
            } else {
                alert("Sorry, we don’t offer services there yet. Continue exploring!");
            }
        })
        .catch(error => {
            console.error("Error fetching destinations:", error);
            alert("Could not check destinations. Try again later.");
        });
    }
    //Allowing event listener to search button
    document.querySelector(".search-btn").addEventListener("click", searchDestination);

    // Allowing  pressing "Enter" to trigger search
    document.querySelector(".search-bar").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
            event.preventDefault();
            searchDestination();
        }
    });

    document.querySelector(".search-btn").addEventListener("click", searchDestination);
    document.querySelector(".search-bar").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
            event.preventDefault();
            searchDestination();
        }
    });

    // Booking Form Submission
    document.getElementById("tourForm").addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent page reload
    
        // Get form values
        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const destination = document.getElementById("destination").value;
        const date = document.getElementById("date").value;
        const people = document.getElementById("people").value;
    
        // Check if the destination exists in the database
        fetch("http://localhost:3000/destinations") // Fetch available destinations
            .then(response => response.json())
            .then(destinations => {
                const foundDestination = destinations.find(d => d.name.toLowerCase() === destination.toLowerCase());
    
                if (foundDestination) {
                    // ✅ Destination exists, proceed with booking
                    document.getElementById("price").value = `$${foundDestination.price}`; // Show price
    
                    const bookingData = {
                        name: name,
                        email: email,
                        destination: destination,
                        date: date,
                        people: people,
                        price: foundDestination.price // Include price in booking
                    };
    
                    // Save the booking to db.json
                    return fetch("http://localhost:3000/bookings", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(bookingData)
                    });
                } else {
                    // Destination NOT found, alert user and prevent booking
                    alert("We currently don't offer tours to this destination. We will contact you if we add it.");
                    return
                }
            })
            .then(response => response.json())
            .then(() => {
                alert("Booking successful!");
                document.getElementById("tourForm").reset(); // Clear form
            })
            .catch(error => console.error("Error booking the tour:", error));
    });
    

    // Review Form Submission
    const reviewForm = document.getElementById("review-form");
    if (reviewForm) {
        reviewForm.addEventListener("submit", function (event) {
            event.preventDefault();

            const reviewerName = document.getElementById("reviewer-name").value;
            const reviewRating = document.getElementById("review-rating").value;
            const reviewText = document.getElementById("review-text").value;

            if (!reviewerName || !reviewRating || !reviewText) {
                alert("Please fill in all fields.");
                return;
            }

            const newReview = {
                id: Date.now(),
                name: reviewerName,
                rating: reviewRating,
                text: reviewText
            };

            fetch("http://localhost:3000/reviews", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(newReview)
            })
            .then(response => response.json())
            .then(() => {
                reviewForm.reset();
                alert("Review submitted successfully!");
                loadReviews(); // Reload reviews after submission
            })
            .catch(error => console.error("Error saving review:", error));
        });
    }

    // Load Reviews and Display Under Featured Destinations
    function loadReviews() {
        fetch("http://localhost:3000/reviews")
            .then(response => response.json())
            .then(reviews => {
                const reviewContainer = document.getElementById("reviews-container");
                if (!reviewContainer) return;

                reviewContainer.innerHTML = ""; // Clear old reviews

                reviews.forEach(review => {
                    const reviewDiv = document.createElement("div");
                    reviewDiv.classList.add("review-item");
                    reviewDiv.innerHTML = `
                        <p><strong>${review.name}</strong> rated: ${"⭐".repeat(review.rating)}</p>
                        <p>${review.text}</p>
                        <button class="edit-review" data-id="${review.id}">Edit</button>
                        <button class="delete-review" data-id="${review.id}">Delete</button>
                    `;
                    reviewContainer.appendChild(reviewDiv);
                });

                // Attach event listeners for edit and delete
                document.querySelectorAll(".edit-review").forEach(button => {
                    button.addEventListener("click", editReview);
                });

                document.querySelectorAll(".delete-review").forEach(button => {
                    button.addEventListener("click", deleteReview);
                });
            })
            .catch(error => console.error("Error loading reviews:", error));
    }

    loadReviews(); // Load reviews on page load

    // Edit Review
    function editReview(event) {
        const reviewId = event.target.getAttribute("data-id");
        const newText = prompt("Edit your review:");

        if (!newText) return;

        fetch(`http://localhost:3000/reviews/${reviewId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: newText })
        })
        .then(() => {
            alert("Review updated!");
            loadReviews();
        })
        .catch(error => console.error("Error updating review:", error));
    }
    // Delete Review
    function deleteReview(event) {
        const reviewId = event.target.getAttribute("data-id");

        if (!confirm("Are you sure you want to delete this review?")) return;

        fetch(`http://localhost:3000/reviews/${reviewId}`, {
            method: "DELETE"
        })
        .then(() => {
            alert("Review deleted!");
            loadReviews();
        })
        .catch(error => console.error("Error deleting review:", error));
    }
});


//Allowing user to see price when they book and to allow them to have other options in destination other than the drop down menu
document.querySelectorAll(".booking").forEach(button => {
    button.addEventListener("click", function () {
        let destinationName = this.getAttribute("data-place"); // Get destination name
        let price = this.getAttribute("data-price"); // Get price

        // Ensure price is set properly
        if (price) {
            document.getElementById("price").value = `$${price}`;  
        } else {
            document.getElementById("price").value = "Price not available"; 
        }

        // Set destination in text input
        document.getElementById("destination").value = destinationName;

        // Scroll to booking form
        window.location.href = "#tourForm";
    });
});


