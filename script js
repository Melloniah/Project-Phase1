document.addEventListener("DOMContentLoaded", function () {
    // Handle "Book" and "Review" Buttons
    document.querySelectorAll(".booking").forEach(button => {
        button.addEventListener("click", function () {
            window.location.href = "#tourForm"; // Scrolls to booking form
        });
    });

    document.querySelectorAll(".user-review").forEach(button => {
        button.addEventListener("click", function () {
            window.location.href = "#review-form"; // Scrolls to review form
        });
    });

    // Search bar functionality
    function searchDestination() {
        let searchInput = document.querySelector(".search-bar").value.trim().toLowerCase();
        fetch("http://localhost:3000/destinations") // Fetch from JSON Server
        .then(response => response.json())
        .then(destinations => {
            let destinationNames = destinations.map(dest => dest.name.toLowerCase());

            if (destinationNames.includes(searchInput)) {
                alert(`We have tours to ${searchInput.charAt(0).toUpperCase() + searchInput.slice(1)}! Click 'Book' to reserve your spot.`);
            } else {
                alert("Sorry, we don’t offer services there yet. Continue exploring!");
            }
        })
        .catch(error => {
            console.error("Error fetching destinations:", error);
            alert("Could not check destinations. Try again later.");
        });
    }

    // Attach event listeners to search
    document.querySelector(".search-btn").addEventListener("click", searchDestination);
    document.querySelector(".search-bar").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
            event.preventDefault();
            searchDestination();
        }
    });

    // Booking Form Submission
    document.getElementById("tourForm").addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent page reload
    
        // Get form values
        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const destination = document.getElementById("destination").value;
        const date = document.getElementById("date").value;
        const people = document.getElementById("people").value;
    
        // Fetch available destinations and check if it exists
        fetch("http://localhost:3000/destinations")
            .then(response => response.json())
            .then(destinations => {
                const foundDestination = destinations.find(d => d.name.toLowerCase() === destination.toLowerCase());

                if (foundDestination) {
                    document.getElementById("price").value = `${foundDestination.price}`; // Show price

                    const bookingData = {
                        name,
                        email,
                        destination,
                        date,
                        people,
                        price: foundDestination.price // Include price in booking
                    };

                    return fetch("http://localhost:3000/bookings", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(bookingData)
                    });
                } else {
                    alert("We currently don't offer tours to this destination. We will contact you if we add it.");
                    return;
                }
            })
            .then(response => response.json())
            .then(() => {
                alert("Booking successful!");
                document.getElementById("tourForm").reset(); // Clear form
            })
            .catch(error => console.error("Error booking the tour:", error));
    });

    // Allowing user to see price when they type in the destination
    fetch("http://localhost:3000/destinations")
        .then(response => response.json())
        .then(destinations => {
            const destinationInput = document.getElementById("destination");
            const priceInput = document.getElementById("price");

            // Listen for user typing in the destination field
            destinationInput.addEventListener("input", function () {
                const userInput = this.value.toLowerCase();
                const matchedDestination = destinations.find(dest => dest.name.toLowerCase() === userInput);

                if (matchedDestination) {
                    priceInput.value = `$${matchedDestination.price}`; // Show price
                } else {
                    priceInput.value = "Price not available"; // Handle unknown destinations
                }
            });
        })
        .catch(error => console.error("Error fetching destinations:", error));

    // Load Reviews
    function loadReviews() {
        fetch("http://localhost:3000/reviews")
            .then(response => response.json())
            .then(reviews => {
                const reviewContainer = document.getElementById("reviews-container");
                if (!reviewContainer) return;

                reviewContainer.innerHTML = ""; // Clear old reviews

                reviews.forEach(review => {
                    const reviewDiv = document.createElement("div");
                    reviewDiv.classList.add("review-item");
                    reviewDiv.innerHTML = `
                        <p><strong>${review.name}</strong> rated: ${"⭐".repeat(review.rating)}</p>
                        <p>${review.text}</p>
                        <button class="edit-review" data-id="${review.id}">Edit</button>
                        <button class="delete-review" data-id="${review.id}">Delete</button>
                    `;
                    reviewContainer.appendChild(reviewDiv);
                });

                // Attach event listeners for edit and delete
                document.querySelectorAll(".edit-review").forEach(button => {
                    button.addEventListener("click", editReview);
                });

                document.querySelectorAll(".delete-review").forEach(button => {
                    button.addEventListener("click", deleteReview);
                });
            })
            .catch(error => console.error("Error loading reviews:", error));
    }

    loadReviews(); // Load reviews on page load

    // Edit Review
    function editReview(event) {
        const reviewId = event.target.getAttribute("data-id");
        const newText = prompt("Edit your review:");

        if (!newText) return;

        fetch(`http://localhost:3000/reviews/${reviewId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: newText })
        })
        .then(() => {
            alert("Review updated!");
            loadReviews();
        })
        .catch(error => console.error("Error updating review:", error));
    }

    // Delete Review
    function deleteReview(event) {
        const reviewId = event.target.getAttribute("data-id");

        if (!confirm("Are you sure you want to delete this review?")) return;

        fetch(`http://localhost:3000/reviews/${reviewId}`, {
            method: "DELETE"
        })
        .then(() => {
            alert("Review deleted!");
            loadReviews();
        })
        .catch(error => console.error("Error deleting review:", error));
    }
});
